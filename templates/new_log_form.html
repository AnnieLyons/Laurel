{% extends 'base.html' %}

{% block title %}New Log{% endblock %}

{% block content %}
<h1>Let birding commence!</h1><br>

<form action="/new_log_entry" method="POST">

  <label for="date">Date</label>
    <input type="date" name="date" id="date"><br>

   <label for="time">Time</label>
    <input type="time" name="time" id="time"><br>

   <label for="location_nickname">Location Nickname</label>
    <input type="text" name="location_nickname" id="location_nickname"><br>

   <label for="location">Location</label>
    <input type="text" name="location" id="location" required readonly><br>

    <div id="result">
      <label for="latitude"></label>
      <input type="hidden" name="latitude" id="latitude">
      <label for="longitude"></label>
      <input type="hidden" name="longitude" id="longitude"> 
            <!--Position information will be inserted here-->
      <button type="button" onclick="showPosition();">Auto Log Your Location</button>
    </div>

   <label for="weather">Weather</label>
    <input type="text" name="weather" id="weather"><br>

   <label for="habitat">Habitat</label>
    <input type="text" name="habitat" id="habitat"><br>

   <label for="equipment">Equipment</label>
    <input type="text" name="equipment" id="equipment"><br>

   <label for="notes">Notes</label>
    <textarea name="notes" id="notes"></textarea><br> 
  
  <label for="bird_select">Birds Seen</label>
  <select name="bird_select" id="bird_select" multiple="multiple"></select>
  
  <br>
    <input type="submit" value="Submit!">
</form>

<a href="/homepage">Return to homepage</a>
<h4>*Laurel is currently compatible with North and Middle American Species</h4>

<script type="text/javascript">

  // <!-- FIXME: Document Ready prevents showPosition from running. -->
  // $(document).ready( () => {

    // Autocomplete bird selection box
    $('#bird_select').select2({
      ajax: {
        url: '/bird_search',
        dataType: 'json',
        method: 'GET',
        data: (params) => {
          return {'search_term': params.term}
        }
      },
      placeholder: "Search for bird name.",
      width: "500px"
    });

    // Location grabbing and display
    const showPosition = () => {
      if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition( (position) => {
          const positionInfoLatitude = position.coords.latitude;
          const positionInfoLongitude = position.coords.longitude;

          $('#latitude').attr('value', positionInfoLatitude);
          $('#longitude').attr('value', positionInfoLongitude);
          // FIXME: Should the API key be secure somehow?
          $.get(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${positionInfoLatitude},${positionInfoLongitude}&key=AIzaSyDkyrsItRXuVawscOhU99GW8n1yvvvDH40`, (response) => {
              $('#location').val(response.results[0].formatted_address);
          });

          const loc = {lat: positionInfoLatitude, lng: positionInfoLongitude};

          $( "#result" ).after( "<div id='map' style='width: 250px; height: 250px;'></div>" );
          
          initMap(loc);
        });
      } else {
          alert("Sorry, your browser does not support HTML5 geolocation.");
      }
    };

    // Initialize and add the map
    function initMap(loc) {

        const map = new google.maps.Map($('#map')[0], {
          zoom: 11,
          center: loc
        });

        const marker = new google.maps.Marker({
            position: loc,
            map: map
        });
    }
  // });
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDkyrsItRXuVawscOhU99GW8n1yvvvDH40" async defer></script>

{% endblock %}


